#!/usr/bin/env python3
"""
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ç–µ–≤–æ–π —Å–∫–∞–Ω–µ—Ä —Å –≤–µ–±-—Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º–∏ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
"""

import sys
import argparse
import logging
import asyncio
from pathlib import Path
from colorama import init, Fore, Back, Style

from config import load_config
from network_scanner import AsyncNetworkScanner
from screenshot_manager import ScreenshotManager, AsyncScreenshotManager
from report_generator import ReportGenerator

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è colorama –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
init(autoreset=True)


def validate_network(network_str: str) -> str:
    """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å–µ—Ç–µ–≤–æ–π –∞–¥—Ä–µ—Å"""
    import ipaddress

    try:
        network = ipaddress.IPv4Network(network_str, strict=False)
        return str(network)
    except ValueError:
        raise ValueError(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–µ—Ç–∏: {network_str}")


def validate_threads(threads: int) -> int:
    """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤"""
    if threads <= 0:
        raise ValueError("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º")
    if threads > 100:
        raise ValueError("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100")
    return threads


def print_colored(text: str, color: str = Fore.WHITE, style: str = ""):
    """–í—ã–≤–æ–¥–∏—Ç —Ü–≤–µ—Ç–Ω–æ–π —Ç–µ–∫—Å—Ç"""
    print(f"{color}{style}{text}{Style.RESET_ALL}")


async def main_async():
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    parser = argparse.ArgumentParser(
        description="–°–µ—Ç–µ–≤–æ–π —Å–∫–∞–Ω–µ—Ä —Å –≤–µ–±-—Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º–∏ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  python main.py 172.30.1.0/24 10
  python main.py 192.168.1.0/24 5 --no-reports
  python main.py 10.0.0.0/24 20 --config custom_config.yaml
  python main.py 192.168.1.0/24 --async  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        """,
    )

    parser.add_argument(
        "network", help="–°–µ—Ç—å –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 192.168.1.0/24)"
    )

    parser.add_argument(
        "threads",
        type=int,
        nargs="?",
        default=10,
        help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10)",
    )

    parser.add_argument(
        "--no-reports",
        action="store_true",
        help="–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å JSON –∏ HTML –æ—Ç—á–µ—Ç—ã (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π)",
    )

    parser.add_argument("--config", type=Path, help="–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")

    parser.add_argument(
        "--output-dir",
        type=Path,
        default=Path("."),
        help="–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤",
    )

    parser.add_argument("--verbose", "-v", action="store_true", help="–ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥")

    parser.add_argument(
        "--async-scan", 
        action="store_true", 
        help="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
    )

    args = parser.parse_args()

    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
        network = validate_network(args.network)
        threads = validate_threads(args.threads)

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config = load_config()
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø—Ü–∏–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        if args.verbose:
            config.log_level = "DEBUG"
        config.output_dir = args.output_dir

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        config.setup_logging()
        logger = logging.getLogger(__name__)

        print_colored("üöÄ –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ç–µ–≤–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞", Fore.CYAN, Style.BRIGHT)
        print_colored(f"–°–µ—Ç—å: {network}", Fore.GREEN)
        print_colored(f"–ü–æ—Ç–æ–∫–∏: {threads}", Fore.GREEN)
        print_colored(f"–í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {config.output_dir}", Fore.GREEN)
        
        if args.async_scan:
            print_colored("‚ö° –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ", Fore.YELLOW, Style.BRIGHT)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        if not network.startswith(("192.168.", "172.", "10.", "127.")):
            print_colored("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–π —Å–µ—Ç–∏!", Fore.RED, Style.BRIGHT)
            print_colored(
                "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π —Å–µ—Ç–∏",
                Fore.RED
            )

        # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        scanner = AsyncNetworkScanner(config)
        report_gen = ReportGenerator(config.output_dir)

        # –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏
        print_colored("üîç –ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏...", Fore.CYAN)
        
        if args.async_scan:
            # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            scan_results = await scanner.scan_network_async(network, max_workers=threads)
        else:
            # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
            scan_results = scanner.scan_network(network, max_workers=threads)

        if not scan_results:
            print_colored("üì≠ –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ö–æ—Å—Ç–æ–≤ —Å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏", Fore.YELLOW)
            return

        print_colored(f"‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–∞–π–¥–µ–Ω–æ {len(scan_results)} —Ö–æ—Å—Ç–æ–≤", Fore.GREEN)

        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
        screenshots_count = {}
        if scan_results:
            print_colored("üì∏ –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤...", Fore.CYAN)
            
            # –°–æ–∑–¥–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è —Å–µ—Ç–∏
            network_name = network.replace('/', '_')
            network_dir = config.output_dir / f"scan-{network_name}"
            network_dir.mkdir(parents=True, exist_ok=True)
            
            if args.async_scan:
                # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
                async with AsyncScreenshotManager(config) as screenshot_mgr:
                    screenshots_count = await screenshot_mgr.create_screenshots_async(
                        scan_results, network_dir
                    )
            else:
                # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                with ScreenshotManager(config) as screenshot_mgr:
                    screenshots_count = screenshot_mgr.create_screenshots(
                        scan_results, network_dir
                    )

        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
        print_colored("üìä –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤...", Fore.CYAN)

        # –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è
        text_report = report_gen.save_text_report(scan_results, network)
        print_colored(f"üìÑ –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç: {text_report}", Fore.GREEN)

        # JSON –∏ HTML –æ—Ç—á–µ—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞—é—Ç—Å—è)
        if not args.no_reports:
            json_report = report_gen.save_json_report(
                scan_results, network, screenshots_count
            )
            html_report = report_gen.save_html_report(
                scan_results, network, screenshots_count
            )
            print_colored(f"üìä JSON –æ—Ç—á–µ—Ç: {json_report}", Fore.GREEN)
            print_colored(f"üåê HTML –æ—Ç—á–µ—Ç: {html_report}", Fore.GREEN)

        # –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        total_ports = sum(len(result.open_ports) for result in scan_results)
        total_screenshots = sum(screenshots_count.values())
        total_scan_time = sum(result.scan_time for result in scan_results)

        print_colored("üéâ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!", Fore.GREEN, Style.BRIGHT)
        print_colored("üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:", Fore.CYAN)
        print_colored(f"   ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ —Ö–æ—Å—Ç–æ–≤: {len(scan_results)}", Fore.WHITE)
        print_colored(f"   ‚Ä¢ –û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤: {total_ports}", Fore.WHITE)
        print_colored(f"   ‚Ä¢ –°–æ–∑–¥–∞–Ω–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤: {total_screenshots}", Fore.WHITE)
        print_colored(f"   ‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {total_scan_time:.2f}—Å", Fore.WHITE)

        # –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        all_services = set()
        for result in scan_results:
            for port in result.open_ports.keys():
                all_services.add(report_gen._get_service_name(port))

        if all_services:
            print_colored("üîß –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã: " + ", ".join(sorted(all_services)), Fore.YELLOW)

    except KeyboardInterrupt:
        print_colored("‚èπÔ∏è  –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º", Fore.RED)
        sys.exit(1)
    except ValueError as e:
        print_colored(f"‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {e}", Fore.RED)
        sys.exit(1)
    except Exception as e:
        print_colored(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}", Fore.RED)
        if args.verbose:
            import traceback
            print_colored(traceback.format_exc(), Fore.RED)
        sys.exit(1)


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        asyncio.run(main_async())
    except KeyboardInterrupt:
        print_colored("‚èπÔ∏è  –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º", Fore.RED)
        sys.exit(1)


if __name__ == "__main__":
    main()
