# Улучшения HTML отчета

## Обзор

Внесены значительные улучшения в HTML отчет для повышения удобства использования и информативности.

## Основные изменения

### 1. Сортировка хостов по IP-адресам

**Было**: Хосты отображались в случайном порядке
**Стало**: Хосты отсортированы по IP-адресам в сетевом порядке

```python
# Сортируем хосты по IP-адресам
sorted_hosts = sorted(scan_results, key=lambda x: [int(part) for part in x.host.split('.')])
```

**Преимущества**:
- Легче найти конкретный хост
- Логичный порядок отображения
- Удобство навигации по отчету

### 2. Скриншоты под информацией о хостах

**Было**: Все скриншоты отображались в отдельной секции внизу отчета
**Стало**: Скриншоты показываются под информацией о соответствующих хостах

```python
# Создаем маппинг хостов к скриншотам
host_screenshots = {}
if task.metadata.get('screenshots') and task.metadata.get('web_hosts'):
    web_hosts = task.metadata.get('web_hosts', [])
    screenshots = task.metadata.get('screenshots', [])
    
    for i, url in enumerate(web_hosts):
        if i < len(screenshots):
            # Извлекаем IP из URL
            from urllib.parse import urlparse
            parsed = urlparse(url)
            host_ip = parsed.hostname
            if host_ip:
                if host_ip not in host_screenshots:
                    host_screenshots[host_ip] = []
                host_screenshots[host_ip].append({
                    'screenshot': screenshots[i],
                    'url': url,
                    'port': parsed.port or (443 if parsed.scheme == 'https' else 80)
                })
```

**Преимущества**:
- Сразу видно, какой веб-сервис на каком хосте
- Не нужно искать соответствие между хостами и скриншотами
- Более интуитивное восприятие информации
- Каждый хост отображается только один раз со всеми портами
- Только один скриншот на хост (приоритет: 80 > 443 > 8080 > 8443)

### 3. Улучшенный дизайн

#### Новые CSS классы:
- `.host-header` - заголовок хоста с информацией и скриншотами
- `.host-info` - основная информация о хосте
- `.host-screenshots` - боковая панель для скриншотов
- `.screenshot-container` - контейнер для скриншота
- `.screenshot-info` - информация о скриншоте (URL, ссылка)
- `.web-service-badge` - бейдж "Веб-сервис"
- `.no-screenshots` - сообщение об отсутствии веб-сервисов

#### Структура карточки хоста:
```html
<div class="host-card">
    <div class="host-header">
        <div class="host-info">
            <h3>IP-адрес - Статус <span class="web-service-badge">Веб-сервис</span></h3>
        </div>
    </div>
    <!-- Информация о портах -->
    <div class="host-screenshots">
        <!-- Скриншоты веб-сервисов -->
    </div>
</div>
```

### 4. Информативные бейджи и метки

- **Бейдж "Веб-сервис"**: Показывается для хостов с веб-интерфейсами
- **URL в скриншоте**: Отображается полный URL веб-сервиса
- **Ссылка на полный размер**: Прямой доступ к оригинальному скриншоту

### 5. Сохранение метаданных

Добавлено сохранение списка веб-хостов в метаданные задачи:

```python
task.metadata['web_hosts'] = web_hosts if web_hosts else []
```

Это позволяет создать правильный маппинг между хостами и скриншотами при генерации отчета.

### 6. Устранение дублирования хостов

**Проблема**: Каждый хост отображался несколько раз (по одному разу на каждый открытый порт)
**Решение**: Создается один результат для хоста со всеми открытыми портами

```python
# Создаем один результат для хоста со всеми открытыми портами
if host_results:
    # Объединяем все баннеры
    all_banners = {}
    for result in host_results:
        all_banners.update(result.banners)
    
    # Создаем единый результат для хоста
    host_result = ScanResult(
        host=host,
        open_ports=open_ports,
        banners=all_banners,
        os_info=os_info,
        response_time=response_time
    )
```

### 7. Скриншоты для всех веб-портов

**Проблема**: Для одного хоста создавался только один скриншот (только для порта с наивысшим приоритетом)
**Решение**: Создание скриншотов для всех веб-портов хоста

```python
# Создаем скриншоты для всех веб-портов хоста
for port in result.open_ports:
    if port in web_ports:
        protocol = "https" if port in [443, 8443, 9443] else "http"
        web_hosts.append(f"{protocol}://{result.host}:{port}")
```

### 8. Улучшенные скриншоты

**Проблема**: Скриншоты были большими и неудобными для просмотра
**Решение**: 
- Уменьшенный размер скриншотов (только видимая область)
- Модальное окно для увеличения при клике
- Игнорирование SSL сертификатов для HTTPS портов
- Автоматическое определение правильного протокола (HTTP/HTTPS)

```python
# Уменьшенные скриншоты
await page.screenshot(
    path=str(screenshot_path), 
    full_page=False,  # Только видимая область
    timeout=10000
)

# Игнорирование SSL сертификатов
context = await browser.new_context(
    ignore_https_errors=True,  # Игнорируем HTTPS ошибки
    # ... другие настройки
)

# Автоматическое определение протокола
if port in [443, 8443, 9443]:
    protocols_to_try = ["https", "http"]  # Сначала HTTPS, потом HTTP
else:
    protocols_to_try = ["http", "https"]  # Сначала HTTP, потом HTTPS
```

**JavaScript для модального окна**:
```javascript
function openScreenshotModal(imageSrc, url) {
    var modal = document.getElementById("screenshotModal");
    var modalImg = document.getElementById("modalImage");
    modal.style.display = "block";
    modalImg.src = imageSrc;
}
```

### 9. Улучшенное логирование скриншотов

**Проблема**: Недостаточно информации о процессе создания скриншотов
**Решение**: Подробное логирование с эмодзи и статусами

```python
# Подробное логирование подключений
self.logger.info(f"Пробуем подключиться к {url}")
self.logger.info(f"✅ Успешное подключение к {url} (статус: {response.status})")
self.logger.info(f"❌ Неудачное подключение к {url} (статус: {status})")
self.logger.info(f"❌ Ошибка при подключении к {url}: {e}")
```

**Дополнительные обработчики**:
- `pageerror` - ошибки JavaScript
- `requestfailed` - неудачные HTTP запросы
- `dialog` - автоматическое принятие диалогов

## Технические детали

### Сортировка IP-адресов

Используется лексикографическая сортировка по числовым частям IP-адреса:
```python
sorted(scan_results, key=lambda x: [int(part) for part in x.host.split('.')])
```

Это обеспечивает правильный порядок: 172.30.1.1, 172.30.1.2, ..., 172.30.1.10, 172.30.1.11

### Маппинг хостов и скриншотов

1. Извлекаем IP-адрес из URL веб-сервиса
2. Создаем словарь `host_screenshots[ip] = [screenshot_info]`
3. При отображении хоста проверяем наличие скриншотов

### Адаптивный дизайн

- Увеличенная максимальная ширина контейнера (1400px)
- Flexbox для размещения информации и скриншотов
- Адаптивные изображения с максимальной шириной 100%

## Результат

### До улучшений:
- Хосты в случайном порядке
- Скриншоты отдельно внизу
- Сложно найти соответствие
- Менее информативно

### После улучшений:
- Хосты отсортированы по IP
- Скриншоты рядом с хостами
- Четкая связь между данными
- Информативные бейджи и метки
- Улучшенный дизайн

## Использование

HTML отчет теперь генерируется автоматически при завершении задачи сканирования и доступен для скачивания в ZIP-архиве. Отчет содержит:

1. **Заголовок** с информацией о задаче
2. **Статистику** по хостам и портам
3. **Детальную информацию** по хостам (отсортированную)
4. **Скриншоты** веб-сервисов рядом с соответствующими хостами

Это значительно улучшает удобство анализа результатов сканирования! 🎯
