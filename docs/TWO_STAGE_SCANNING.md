# Двухэтапное сканирование

## Обзор

Сетевой сканер использует интеллектуальное двухэтапное сканирование для максимальной эффективности и скорости работы.

## Архитектура

### Этап 1: Обнаружение активных хостов (улучшенное)

**Цель**: Быстро определить, какие хосты в сети активны и отвечают на сетевые запросы.

**Методы**:
1. **TCP ping на множественные порты**:
   - **80, 443** - HTTP/HTTPS (веб-серверы, камеры, роутеры)
   - **22, 23** - SSH/Telnet (Linux серверы, сетевые устройства)
   - **3389** - RDP (Windows серверы)
   - **554** - RTSP (IP камеры)
   - **37777, 37778** - Dahua камеры
   - **8080, 8000, 9000** - Альтернативные HTTP порты

2. **ICMP ping** (опционально):
   - Дополнительный метод для устройств без открытых портов
   - Настраивается через `use_icmp_ping: bool`

**Настройки**:
- **Таймаут**: 0.5 секунды на соединение (настраивается)
- **Параллельность**: Все хосты проверяются одновременно
- **Порядок**: TCP порты → ICMP ping (если включен)

**Преимущества**:
- Обнаруживает разные типы устройств (Windows, Linux, камеры, коммутаторы)
- Очень быстрое обнаружение (1-2 секунды на сотни хостов)
- Надежное определение активных хостов
- Минимальная нагрузка на сеть
- Настраиваемые таймауты для оптимизации скорости

### Этап 2: Сканирование портов

**Цель**: Детальное сканирование портов только на активных хостах.

**Метод**: Параллельное сканирование всех портов одного хоста
- **Порты**: 21, 22, 23, 25, 53, 80, 110, 143, 443, 993, 995, 8080, 8443
- **Параллельность**: Все порты одного хоста сканируются одновременно
- **Баннеры**: Получение и анализ баннеров сервисов

## Преимущества

### Экономия времени

| Сценарий | Традиционное сканирование | Двухэтапное сканирование | Экономия |
|----------|---------------------------|---------------------------|----------|
| Сеть /24 (254 хоста), 10% активных | 254 × 13 = 3,302 проверки | 25 × 13 = 325 проверки | **90%** |
| Сеть /16 (65,534 хоста), 5% активных | 65,534 × 13 = 851,942 проверки | 3,277 × 13 = 42,601 проверка | **95%** |
| Сеть /8 (16,777,214 хоста), 1% активных | 16,777,214 × 13 = 218,103,782 проверки | 167,772 × 13 = 2,181,036 проверок | **99%** |

### Эффективность использования ресурсов

- **CPU**: Фокус на реально существующих хостах
- **Сеть**: Минимизация ненужного трафика
- **Время**: Значительное ускорение на больших сетях

### Надежность

- **Обнаружение**: TCP соединения более надежны чем ICMP ping
- **Фильтрация**: Исключение неактивных хостов снижает ложные срабатывания
- **Стабильность**: Меньше таймаутов и ошибок соединения

## Техническая реализация

### Метод обнаружения хостов

```python
async def ping_host_async(self, host: str) -> bool:
    """Быстрая проверка доступности хоста (ping)"""
    async with self.semaphore:
        try:
            # Пробуем порт 80 (HTTP)
            reader, writer = await asyncio.wait_for(
                asyncio.open_connection(host, 80),
                timeout=1.0
            )
            writer.close()
            await writer.wait_closed()
            return True
        except:
            # Если порт 80 недоступен, пробуем порт 22 (SSH)
            try:
                reader, writer = await asyncio.wait_for(
                    asyncio.open_connection(host, 22),
                    timeout=1.0
                )
                writer.close()
                await writer.wait_closed()
                return True
            except:
                return False
```

### Параллельное обнаружение

```python
async def discover_active_hosts(self, hosts: List[str]) -> List[str]:
    """Обнаружение активных хостов в сети"""
    # Создаем задачи для параллельного ping всех хостов
    ping_tasks = [self.ping_host_async(host) for host in hosts]
    
    # Выполняем все ping параллельно
    ping_results = await asyncio.gather(*ping_tasks, return_exceptions=True)
    
    # Собираем активные хосты
    active_hosts = []
    for i, is_active in enumerate(ping_results):
        if is_active:
            active_hosts.append(hosts[i])
    
    return active_hosts
```

## Логирование

### Этап 1: Обнаружение

```
2025-08-13 09:22:56 - network_scanner - INFO - === ЭТАП 1: ОБНАРУЖЕНИЕ АКТИВНЫХ ХОСТОВ ===
2025-08-13 09:22:56 - network_scanner - INFO - Начинаем обнаружение из 14 хостов...
2025-08-13 09:22:58 - network_scanner - INFO - Обнаружение: 1/14 - ✓ 172.30.1.1
2025-08-13 09:22:58 - network_scanner - INFO - Обнаружение: 2/14 - ✗ 172.30.1.2
...
2025-08-13 09:22:58 - network_scanner - INFO - === ЗАВЕРШЕНИЕ ОБНАРУЖЕНИЯ ===
2025-08-13 09:22:58 - network_scanner - INFO - Обнаружено 6 активных хостов из 14
2025-08-13 09:22:58 - network_scanner - INFO - Эффективность обнаружения: 42.9%
```

### Этап 2: Сканирование портов

```
2025-08-13 09:22:58 - network_scanner - INFO - === ЭТАП 2: СКАНИРОВАНИЕ ПОРТОВ ===
2025-08-13 09:22:58 - network_scanner - INFO - Начинаем сканирование портов на 6 активных хостах...
2025-08-13 09:22:58 - network_scanner - INFO - ✓ 172.30.1.6: найдены открытые порты [22]
2025-08-13 09:22:58 - network_scanner - INFO - ✓ 172.30.1.12: найдены открытые порты [22, 80, 443]
...
```

## Настройки

### Конфигурация обнаружения

```python
# В config.py
probe_timeout: int = 2  # Таймаут для сканирования портов
ping_timeout: int = 1   # Таймаут для обнаружения хостов (неявный)
```

### Оптимизация для разных сетей

#### Маленькие сети (до /24)
- Двухэтапное сканирование может быть избыточным
- Можно отключить этап обнаружения для максимальной скорости

#### Средние сети (/24 - /16)
- Оптимальное использование двухэтапного сканирования
- Значительная экономия времени

#### Большие сети (/16+)
- Максимальная эффективность двухэтапного сканирования
- Критически важна для практического использования

## Сравнение с традиционным сканированием

### Традиционное сканирование
```
Сеть: 192.168.1.0/24 (254 хоста)
Время: 254 × 13 портов × 2 сек = 6,604 секунд (1.8 часа)
Результат: 25 активных хостов с открытыми портами
```

### Двухэтапное сканирование
```
Сеть: 192.168.1.0/24 (254 хоста)
Этап 1: 254 хоста × 1 сек = 254 секунды (4.2 минуты)
Этап 2: 25 хостов × 13 портов × 2 сек = 650 секунд (10.8 минут)
Общее время: 904 секунды (15 минут)
Экономия: 86% времени
```

## Заключение

Двухэтапное сканирование представляет собой значительный прорыв в эффективности сетевого сканирования:

- **Скорость**: До 99% экономии времени на больших сетях
- **Эффективность**: Фокус на реально существующих хостах
- **Надежность**: Более стабильные результаты
- **Масштабируемость**: Возможность сканирования очень больших сетей

Это делает сканер пригодным для использования в реальных производственных средах с большими сетями.
